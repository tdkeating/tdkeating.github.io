# Packages Setup
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(reshape2)
library(GGally)
library(VIM)
library(geepack)
library(multcomp)
library(wgeesel)
#------------------------
# Data
acl_wide<- read_csv("Data/acl_subset.csv")[,-1]
acl_wide$race<- as.factor(acl_wide$race)
acl_long<- melt(acl_wide, id=c("id","sex", "race", "ses","age"))
acl_long<- arrange(acl_long, id, variable)
acl_long <- acl_long %>% mutate(year= case_when(variable=="w1" ~ 1986,
variable=="w2" ~ 1989,
variable=="w3" ~ 1994,
variable=="w4" ~ 2002,
variable=="w5" ~ 2011))
acl_long$year_from_baseline<- acl_long$year - 1986
acl_long$lag1value<- ylag(acl_long$id, acl_long$value, 1)
acl_long$missing<- ifelse(is.na(acl_long$value),1,0)
acl_wide$miss<- apply(is.na(acl_wide), 1, any)
#-------------------------
# Summary Table
summary_tab<- acl_long %>% group_by(race,year) %>%
summarise(nobs=n()-sum(missing),
nmissing=sum(missing),
n_impaired=sum(value, na.rm=TRUE),
percent_impaired=mean(value, na.rm=TRUE))
# plot of % functionally impaired over time by race
ggplot(data=summary_tab, mapping=aes(x=year, y=100*percent_impaired,
group=race, colour=race)) +
geom_line() +
labs(x="Year", y="% Functionally Impaired", colour="Race") +
scale_colour_manual(values=c("red", "blue"),
labels=c("African American", "White American")) +
scale_x_continuous(breaks=c(1986,1989,1994,2002,2011)) +
theme_bw()
#----------------------------
# Missing Data Patterns
aggr_plot<- aggr(acl_wide[,6:10],
col=c("navyblue","red"),
numbers=TRUE,
sortVars=TRUE,
labels=c("1986","1989","1994","2002","2011"),
cex.axis=0.7,
gap=3,
ylab=c("Histogram of Missing Data","Pattern of Missing Data"))
spineMiss(as.data.frame(acl_wide[, c("race", "w1")]),
xlab="Race", ylab="% Missing- 1986")
spineMiss(as.data.frame(acl_wide[,c("race", "w2")]),
xlab="Race", ylab="% Missing- 1989")
spineMiss(as.data.frame(acl_wide[,c("race", "w3")]),
xlab="Race", ylab="% Missing- 1994")
spineMiss(as.data.frame(acl_wide[,c("race", "w4")]),
xlab="Race", ylab="% Missing- 2002")
spineMiss(as.data.frame(acl_wide[,c("race", "w5")]),
xlab="Race", ylab="% Missing- 2011")
# Complete vs Missing observations comparison
missing_comparison_tab<- acl_wide %>% group_by(race, miss) %>%
summarise(N=n(),
percent_1986=mean(w1),
percent_1989=mean(w2, na.rm=TRUE),
percent_1994=mean(w3, na.rm=TRUE),
percent_2002=mean(w4, na.rm=TRUE),
percent_2011=mean(w5, na.rm=TRUE))
missing_comparison_tab[,4:8]<- round(missing_comparison_tab[,4:8], digits=3)
colnames(missing_comparison_tab)<- c("Race", "Missing Observations", "Number",
"% Impaired 1986",
"% Impaired 1989",
"% Impaired 1994",
"% Impaired 2002",
"% Impaired 2011")
kable(missing_comparison_tab,
caption= "% Functionally Impaired for Individuals with Complete vs Missing Data")
#--------------------------
# Models
#------------------------
#Q2 Modeling
#gee model with available data and adjusting for past functional impairment status
acl_long_subset<- acl_long[complete.cases(acl_long),]
gee_with_past<- geeglm(value ~ race*year + sex + ses + age + lag1value,
id=id,
data=acl_long_subset,
family=binomial(link="logit"),
corstr="independence")
#Estimates and CI's for OR per year for each race
gee_with_past_raceAA_peryear<- glht(gee_with_past, "year = 0")
ci_gee_with_past_raceAA_peryear<- (confint(gee_with_past_raceAA_peryear)$confint)[1,]
exp_ci_gee_with_past_raceAA_peryear<- exp(ci_gee_with_past_raceAA_peryear)
gee_with_past_raceW_peryear<- glht(gee_with_past, "year + raceW:year = 0")
ci_gee_with_past_raceW_peryear<- (confint(gee_with_past_raceW_peryear)$confint)[1,]
exp_ci_gee_with_past_raceW_peryear<- exp(ci_gee_with_past_raceW_peryear)
#Estimates and CI's for OR by lag1value
gee_with_past_lag1value<- glht(gee_with_past, "lag1value = 0")
ci_gee_with_past_lag1value<- (confint(gee_with_past_lag1value)$confint)[1,]
exp_ci_gee_with_past_lag1value<- exp(ci_gee_with_past_lag1value)
#Table of Estimates for Q2 (log-odds scale)
summary_gee_with_past<- (summary(gee_with_past))$coefficients
summary_gee_with_past<- summary_gee_with_past[,-3]
summary_gee_with_past<- as.data.frame(round(summary_gee_with_past, digits=3))
row.names(summary_gee_with_past)<- c("Intercept", "White American","Year",
"Male","Middle SES Class","Upper SES Class",
"Baseline Age","Past Functional Impairment Status",
"White American:Year")
colnames(summary_gee_with_past)<- c("Estimate", "Std Error", "p-value")
kable(summary_gee_with_past,
caption= "Log Odds Estimates for GEE Model adjusting for Past Functional Impairment")
#------------------------
#Q3 Modeling
#available data model
acl_long_available<- acl_long[complete.cases(acl_long$value),]
gee_available<- geeglm(value ~ race*year_from_baseline + sex + ses + age,
id=id,
data=acl_long_available,
family=binomial(link="logit"),
corstr="independence")
#Estimates and CI's for OR between races at baseline (year=1986)
gee_available_raceW_est<- glht(gee_available, "raceW = 0")
ci_gee_available_raceW_est<- (confint(gee_available_raceW_est)$confint)[1,]
exp_ci_gee_available_raceW_est<- exp(ci_gee_available_raceW_est)
#Estimates and CI's for OR per year for each race
gee_available_raceAA_peryear<- glht(gee_available, "year_from_baseline = 0")
ci_gee_available_raceAA_peryear<- (confint(gee_available_raceAA_peryear)$confint)[1,]
exp_ci_gee_available_raceAA_peryear<- exp(ci_gee_available_raceAA_peryear)
gee_available_raceW_peryear<- glht(gee_available,
"year_from_baseline + raceW:year_from_baseline = 0")
ci_gee_available_raceW_peryear<- (confint(gee_available_raceW_peryear)$confint)[1,]
exp_ci_gee_available_raceW_peryear<- exp(ci_gee_available_raceW_peryear)
#IPW model
#make monotone dropout in wide format
acl_wide_ipw<- acl_wide %>% dplyr::select(!miss)
acl_wide_ipw[is.na(acl_wide_ipw$w1), 7:10]<- NA
acl_wide_ipw[is.na(acl_wide_ipw$w2), 8:10]<- NA
acl_wide_ipw[is.na(acl_wide_ipw$w3), 9:10]<- NA
acl_wide_ipw[is.na(acl_wide_ipw$w4), 10]<- NA
#reshape into long format and add variables needed
acl_long_ipw<- melt(acl_wide_ipw, id=c("id","sex", "race", "ses","age"))
acl_long_ipw<- arrange(acl_long_ipw, id, variable)
acl_long_ipw <- acl_long_ipw %>% mutate(year= case_when(variable=="w1" ~ 1986,
variable=="w2" ~ 1989,
variable=="w3" ~ 1994,
variable=="w4" ~ 2002,
variable=="w5" ~ 2011))
acl_long_ipw$year_from_baseline<- acl_long_ipw$year - 1986
acl_long_ipw$lag1value<- ylag(acl_long_ipw$id, acl_long_ipw$value, 1)
acl_long_ipw$R<- ifelse(is.na(acl_long_ipw$value),0,1)
#ipw gee model
gee_ipw<- wgee(model= value ~ race*year_from_baseline + sex + ses + age,
id=acl_long_ipw$id,
data=acl_long_ipw,
family=binomial(link="logit"),
corstr="independence",
scale=NULL,
mismodel= R ~ race + year_from_baseline + sex + ses + age + lag1value)
#Estimates and CI's for OR between races at baseline (year=1986)
lambda<- c(0,1,0,0,0,0,0,0)
exp_gee_ipw_raceW_est<- exp(lambda %*% gee_ipw$beta)
exp_ci_gee_ipw_raceW_est<- exp(lambda %*% gee_ipw$beta + qnorm(c(0.025,0.975)) *
c(sqrt(lambda %*% gee_ipw$var %*% lambda)))
#Estimates and CI's for OR per year for each race
lambda1<- c(0,0,1,0,0,0,0,0)
lambda2<- c(0,0,1,0,0,0,0,1)
exp_gee_ipw_raceAA_peryear<- exp(lambda1 %*% gee_ipw$beta)
exp_ci_gee_ipw_raceAA_peryear<- exp(lambda1 %*% gee_ipw$beta + qnorm(c(0.025,0.975)) *
c(sqrt(lambda1 %*% gee_ipw$var %*% lambda1)))
exp_gee_ipw_raceW_peryear<- exp(lambda2 %*% gee_ipw$beta)
exp_ci_gee_ipw_raceW_peryear<- exp(lambda2 %*% gee_ipw$beta + qnorm(c(0.025,0.975)) *
c(sqrt(lambda2 %*% gee_ipw$var %*% lambda2)))
#Comparison of primary and sensitivity table (log-odds scale) for Q3
summary_gee_available<- (summary(gee_available))$coefficients
summary_gee_available<- summary_gee_available[,-3]
summary_gee_ipw<- summary(gee_ipw)
summary_gee_ipw<- cbind(summary_gee_ipw$beta, summary_gee_ipw$se.robust, summary_gee_ipw$p)
comparison_tab<- cbind(summary_gee_available, summary_gee_ipw)
comparison_tab<- as.data.frame(round(comparison_tab, digit=3))
row.names(comparison_tab)<- c("Intercept","White American", "Years after 1986",
"Male","Middle SES Class", "Upper SES Class",
"Baseline Age", "White American : Years after 1986")
colnames(comparison_tab)<- c("GEE Available Estimate", "GEE Available Std Err",
"GEE Available p-value","IPW GEE Estimate",
"IPW GEE Std Err", "IPW GEE p-value")
kable(comparison_tab, caption= "Log Odds Estimates for GEE Available and IPW GEE Models")
getwd()
install.packages("tinytex")
tinytex::reinstall_tinytex()
knit_with_parameters("~/Documents/GitHub/trends_functional_impairment/Trends In Functional Impairment.Rmd")
remove.packages("tinytex")
install.packages("tinytex")
install.packages("tinytex")
remove.packages("tinytex")
install.packages("tinytex")
# Packages Setup
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(reshape2)
library(GGally)
library(VIM)
library(geepack)
library(multcomp)
library(wgeesel)
getwd()
# Packages Setup
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(reshape2)
library(GGally)
library(VIM)
library(geepack)
library(multcomp)
library(wgeesel)
getwd()
# Packages Setup
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
library(kableExtra)
library(tidyverse)
library(reshape2)
library(GGally)
library(VIM)
library(geepack)
library(multcomp)
library(wgeesel)
#------------------------
# Data
acl_wide<- read_csv("Data/acl_subset.csv")[,-1]
acl_wide$race<- as.factor(acl_wide$race)
acl_long<- melt(acl_wide, id=c("id","sex", "race", "ses","age"))
acl_long<- arrange(acl_long, id, variable)
acl_long <- acl_long %>% mutate(year= case_when(variable=="w1" ~ 1986,
variable=="w2" ~ 1989,
variable=="w3" ~ 1994,
variable=="w4" ~ 2002,
variable=="w5" ~ 2011))
acl_long$year_from_baseline<- acl_long$year - 1986
acl_long$lag1value<- ylag(acl_long$id, acl_long$value, 1)
acl_long$missing<- ifelse(is.na(acl_long$value),1,0)
acl_wide$miss<- apply(is.na(acl_wide), 1, any)
#-------------------------
# Summary Table
summary_tab<- acl_long %>% group_by(race,year) %>%
summarise(nobs=n()-sum(missing),
nmissing=sum(missing),
n_impaired=sum(value, na.rm=TRUE),
percent_impaired=mean(value, na.rm=TRUE))
# plot of % functionally impaired over time by race
ggplot(data=summary_tab, mapping=aes(x=year, y=100*percent_impaired,
group=race, colour=race)) +
geom_line() +
labs(x="Year", y="% Functionally Impaired", colour="Race") +
scale_colour_manual(values=c("red", "blue"),
labels=c("African American", "White American")) +
scale_x_continuous(breaks=c(1986,1989,1994,2002,2011)) +
theme_bw()
#----------------------------
# Missing Data Patterns
aggr_plot<- aggr(acl_wide[,6:10],
col=c("navyblue","red"),
numbers=TRUE,
sortVars=TRUE,
labels=c("1986","1989","1994","2002","2011"),
cex.axis=0.7,
gap=3,
ylab=c("Histogram of Missing Data","Pattern of Missing Data"))
spineMiss(as.data.frame(acl_wide[, c("race", "w1")]),
xlab="Race", ylab="% Missing- 1986")
spineMiss(as.data.frame(acl_wide[,c("race", "w2")]),
xlab="Race", ylab="% Missing- 1989")
spineMiss(as.data.frame(acl_wide[,c("race", "w3")]),
xlab="Race", ylab="% Missing- 1994")
spineMiss(as.data.frame(acl_wide[,c("race", "w4")]),
xlab="Race", ylab="% Missing- 2002")
spineMiss(as.data.frame(acl_wide[,c("race", "w5")]),
xlab="Race", ylab="% Missing- 2011")
missing_comparison_tab<- acl_wide %>% group_by(race, miss) %>%
summarise(N=n(),
percent_1986=mean(w1),
percent_1989=mean(w2, na.rm=TRUE),
percent_1994=mean(w3, na.rm=TRUE),
percent_2002=mean(w4, na.rm=TRUE),
percent_2011=mean(w5, na.rm=TRUE))
missing_comparison_tab[,4:8]<- round(missing_comparison_tab[,4:8], digits=3)
colnames(missing_comparison_tab)<- c("Race", "Missing Observations", "Number",
"% Impaired 1986",
"% Impaired 1989",
"% Impaired 1994",
"% Impaired 2002",
"% Impaired 2011")
kable(missing_comparison_tab,
caption= "% Functionally Impaired for Individuals with Complete vs Missing Data")  %>%
kable_styling(latex_options= c("striped", "bordered"),
position="center",
full_width = TRUE)
kable(missing_comparison_tab,
format="pdf",
caption= "% Functionally Impaired for Individuals with Complete vs Missing Data") %>%
kable_styling(bootstrap_options= c("striped", "bordered"),
position="center",
full_width = TRUE)
kable(missing_comparison_tab,
format="latex",
caption= "% Functionally Impaired for Individuals with Complete vs Missing Data") %>%
kable_styling(latex_options= c("striped", "bordered"),
position="center",
full_width = TRUE)
kable(missing_comparison_tab,
format="latex",
caption= "% Functionally Impaired for Individuals with Complete vs Missing Data") %>%
kable_styling(latex_options= c("striped", "bordered"),
position="center",
full_width = TRUE)
missing_comparison_tab
